// index.js - è¨¼æ˜æ›¸èªè¨¼ + CloudAdapter + / ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå¯¾å¿œç‰ˆ

const fs = require('fs');
const path = require('path');
const express = require('express');
const { CloudAdapter, ConfigurationBotFrameworkAuthentication } = require('botbuilder');
const GLJTeamsBot = require('./teamsBot');
const redisClient = require('./redisClient');
const logger = require('./logger');
require('./appInsights');

try {
  const app = express();
  const PORT = process.env.PORT || 3978;

  // è¨¼æ˜æ›¸ãƒ­ã‚°å‡ºåŠ›
  const certPath = process.env.MicrosoftAppCertificateFile;
  const certThumbprint = process.env.MicrosoftAppCertificateThumbprint;
  const certPassword = process.env.MicrosoftAppCertificatePassword || '';

  logger.info(`ğŸ“ è¨¼æ˜æ›¸ãƒ‘ã‚¹: ${certPath}`);
  logger.info(`ğŸ”‘ æ‹‡å°: ${certThumbprint}`);
  logger.info(`ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ${certPassword === '' ? '(ç©ºæ–‡å­—)' : '(ãƒã‚¹ã‚¯æ¸ˆã¿)'}`);
  logger.info(`ğŸ“„ è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª: ${fs.existsSync(certPath)}`);
  logger.info('ğŸ” è¨¼æ˜æ›¸èªè¨¼ã‚’ä½¿ç”¨ä¸­');

  const privateKey = fs.readFileSync(certPath);
  logger.info(`âœ… fs.readFileSync æˆåŠŸã€‚ãƒã‚¤ãƒˆé•·: ${privateKey.length}`);

  // Bot Framework èªè¨¼ï¼ˆè¨¼æ˜æ›¸å¯¾å¿œï¼‰
  const botFrameworkAuthentication = new ConfigurationBotFrameworkAuthentication(process.env);
  const adapter = new CloudAdapter(botFrameworkAuthentication);

  adapter.onTurnError = async (context, error) => {
    logger.error(`âŒ [onTurnError] ${error}`);
    await context.sendActivity('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  };

  // Bot ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
  const bot = new GLJTeamsBot(redisClient);

  // âœ… Azure å´ã® startup probe å‘ã‘ãƒ«ãƒ¼ãƒˆ
  app.get('/', (req, res) => {
    res.status(200).send('Bot is running.');
  });

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  app.post('/api/messages', express.json(), async (req, res) => {
    await adapter.process(req, res, async (context) => {
      await bot.run(context);
    });
  });

  app.listen(PORT, () => {
    logger.info(`ğŸŸ¢ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¸­ï¼šhttp://localhost:${PORT}`);
  });

} catch (err) {
  console.error('âŒ Fatal error on startup:', err);
  process.exit(1);
}

